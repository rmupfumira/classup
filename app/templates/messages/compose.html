{% extends "base.html" %}

{% block title %}Compose Message - {{ app_name }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex items-center gap-4">
        <a href="/messages" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
        </a>
        <h1 class="text-2xl font-bold text-gray-900">Compose Message</h1>
    </div>

    <!-- Compose Form -->
    <form id="compose-form" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-6 space-y-6">
            <!-- Message Type -->
            <div>
                <label for="message_type" class="block text-sm font-medium text-gray-700 mb-1">Message Type</label>
                <select id="message_type" name="message_type" required
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500"
                        onchange="handleTypeChange()">
                    <option value="">Select type...</option>
                    {% if user.role in ['SUPER_ADMIN', 'SCHOOL_ADMIN'] %}
                    <option value="ANNOUNCEMENT" {% if message_type == 'ANNOUNCEMENT' %}selected{% endif %}>School Announcement</option>
                    {% endif %}
                    <option value="CLASS_ANNOUNCEMENT" {% if message_type == 'CLASS_ANNOUNCEMENT' %}selected{% endif %}>Class Announcement</option>
                    <option value="STUDENT_MESSAGE" {% if message_type == 'STUDENT_MESSAGE' or selected_student %}selected{% endif %}>Student Message</option>
                </select>
            </div>

            <!-- Class Selection (for class announcements and student messages) -->
            <div id="class-section" class="{% if not selected_student %}{% endif %}">
                <label for="class_id" class="block text-sm font-medium text-gray-700 mb-1">Class</label>
                <select id="class_id" name="class_id"
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500"
                        onchange="handleClassChange()">
                    <option value="">Select class...</option>
                    {% for cls in classes %}
                    <option value="{{ cls.id }}" {% if selected_class and selected_class.id == cls.id %}selected{% endif %}>
                        {{ cls.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Student Selection (for student messages) -->
            <div id="student-section" class="hidden">
                <label for="student_id" class="block text-sm font-medium text-gray-700 mb-1">Student</label>
                <select id="student_id" name="student_id"
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Select student...</option>
                    {% for student in students %}
                    <option value="{{ student.id }}" {% if selected_student and selected_student.id == student.id %}selected{% endif %}>
                        {{ student.first_name }} {{ student.last_name }}
                    </option>
                    {% endfor %}
                </select>
                <p class="mt-1 text-xs text-gray-500">The student's parents will receive this message</p>
            </div>

            <!-- Subject -->
            <div>
                <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                <input type="text" id="subject" name="subject" maxlength="255"
                       placeholder="Enter subject..."
                       class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500">
            </div>

            <!-- Body -->
            <div>
                <label for="body" class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                <textarea id="body" name="body" rows="8" required
                          placeholder="Write your message..."
                          class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500"></textarea>
            </div>

            <!-- Attachments -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Attachments</label>
                <div id="attachments-list" class="space-y-2 mb-3">
                    <!-- Attachment items will be added here -->
                </div>
                <button type="button" onclick="document.getElementById('file-input').click()"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                    <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                    </svg>
                    Add Attachment
                </button>
                <input type="file" id="file-input" class="hidden" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.webp">
                <p class="mt-1 text-xs text-gray-500">Max 10MB per file. Supported: PDF, Word, Images</p>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-end gap-3">
            <a href="/messages"
               class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                Cancel
            </a>
            <button type="submit"
                    class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                Send Message
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const attachmentIds = [];

function handleTypeChange() {
    const type = document.getElementById('message_type').value;
    const classSection = document.getElementById('class-section');
    const studentSection = document.getElementById('student-section');
    const classSelect = document.getElementById('class_id');
    const studentSelect = document.getElementById('student_id');

    if (type === 'ANNOUNCEMENT') {
        classSection.classList.add('hidden');
        studentSection.classList.add('hidden');
        classSelect.required = false;
        studentSelect.required = false;
    } else if (type === 'CLASS_ANNOUNCEMENT') {
        classSection.classList.remove('hidden');
        studentSection.classList.add('hidden');
        classSelect.required = true;
        studentSelect.required = false;
    } else if (type === 'STUDENT_MESSAGE') {
        classSection.classList.remove('hidden');
        studentSection.classList.remove('hidden');
        classSelect.required = false;
        studentSelect.required = true;
    } else {
        classSection.classList.add('hidden');
        studentSection.classList.add('hidden');
    }
}

async function handleClassChange() {
    const classId = document.getElementById('class_id').value;
    const studentSelect = document.getElementById('student_id');

    if (!classId) {
        studentSelect.innerHTML = '<option value="">Select student...</option>';
        return;
    }

    try {
        const response = await fetch(`/api/v1/students?class_id=${classId}&is_active=true&page_size=100`, {
            credentials: 'same-origin'
        });
        const result = await response.json();

        if (result.data) {
            studentSelect.innerHTML = '<option value="">Select student...</option>';
            result.data.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.first_name} ${student.last_name}`;
                studentSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error fetching students:', error);
    }
}

// Initialize form state
document.addEventListener('DOMContentLoaded', function() {
    handleTypeChange();
});

// File upload handling
document.getElementById('file-input').addEventListener('change', async function(e) {
    const files = e.target.files;
    if (!files.length) return;

    for (const file of files) {
        if (file.size > 10 * 1024 * 1024) {
            alert(`File ${file.name} is too large. Max 10MB.`);
            continue;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('file_category', 'DOCUMENT');

        try {
            const response = await fetch('/api/v1/files/upload', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            });

            const result = await response.json();

            if (response.ok && result.data) {
                attachmentIds.push(result.data.id);
                addAttachmentToList(result.data.id, file.name);
            } else {
                alert(`Failed to upload ${file.name}`);
            }
        } catch (error) {
            console.error('Error uploading file:', error);
            alert(`Failed to upload ${file.name}`);
        }
    }

    // Clear the input
    e.target.value = '';
});

function addAttachmentToList(id, name) {
    const list = document.getElementById('attachments-list');
    const item = document.createElement('div');
    item.className = 'flex items-center justify-between px-3 py-2 bg-gray-100 rounded-lg';
    item.dataset.attachmentId = id;
    item.innerHTML = `
        <div class="flex items-center">
            <svg class="w-5 h-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            <span class="text-sm text-gray-700">${name}</span>
        </div>
        <button type="button" onclick="removeAttachment('${id}')" class="text-gray-400 hover:text-red-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    `;
    list.appendChild(item);
}

function removeAttachment(id) {
    const index = attachmentIds.indexOf(id);
    if (index > -1) {
        attachmentIds.splice(index, 1);
    }
    const item = document.querySelector(`[data-attachment-id="${id}"]`);
    if (item) {
        item.remove();
    }
}

// Form submission
document.getElementById('compose-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const messageType = document.getElementById('message_type').value;
    const classId = document.getElementById('class_id').value;
    const studentId = document.getElementById('student_id').value;
    const subject = document.getElementById('subject').value.trim();
    const body = document.getElementById('body').value.trim();

    if (!messageType) {
        alert('Please select a message type');
        return;
    }

    if (!body) {
        alert('Please enter a message');
        return;
    }

    if (messageType === 'CLASS_ANNOUNCEMENT' && !classId) {
        alert('Please select a class');
        return;
    }

    if (messageType === 'STUDENT_MESSAGE' && !studentId) {
        alert('Please select a student');
        return;
    }

    const payload = {
        message_type: messageType,
        subject: subject || null,
        body: body,
        class_id: classId || null,
        student_id: studentId || null,
        attachment_ids: attachmentIds
    };

    try {
        const response = await fetch('/api/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok) {
            alert('Message sent successfully!');
            window.location.href = '/messages/sent';
        } else {
            alert(result.message || 'Failed to send message');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message. Please try again.');
    }
});
</script>
{% endblock %}
