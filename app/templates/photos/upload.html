{% extends "base.html" %}

{% block title %}Upload Photos - {{ app_name }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex items-center gap-4">
        <a href="/photos" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
        </a>
        <h1 class="text-2xl font-bold text-gray-900">Upload Photos</h1>
    </div>

    <!-- Upload Form -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-6 space-y-6">
            <!-- Share Options -->
            <div class="space-y-4">
                <label class="block text-sm font-medium text-gray-700">Share With</label>
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="share_type" value="CLASS" checked
                               class="w-4 h-4 text-primary-600 border-gray-300 focus:ring-primary-500"
                               onchange="handleShareTypeChange()">
                        <span class="ml-2 text-sm text-gray-700">Class</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="share_type" value="STUDENT"
                               class="w-4 h-4 text-primary-600 border-gray-300 focus:ring-primary-500"
                               onchange="handleShareTypeChange()">
                        <span class="ml-2 text-sm text-gray-700">Specific Student</span>
                    </label>
                </div>
            </div>

            <!-- Class Selection -->
            <div id="class-section">
                <label for="class_id" class="block text-sm font-medium text-gray-700 mb-1">Class</label>
                <select id="class_id" name="class_id" required
                        class="block w-full sm:w-64 rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500"
                        onchange="handleClassChange()">
                    <option value="">Select class...</option>
                    {% for cls in classes %}
                    <option value="{{ cls.id }}" {% if selected_class_id and (selected_class_id|string) == (cls.id|string) %}selected{% endif %}>
                        {{ cls.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Student Selection (hidden by default) -->
            <div id="student-section" class="hidden">
                <label for="student_id" class="block text-sm font-medium text-gray-700 mb-1">Student</label>
                <select id="student_id" name="student_id"
                        class="block w-full sm:w-64 rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Select student...</option>
                </select>
                <p class="mt-1 text-xs text-gray-500">Photos will be shared with this student's parents</p>
            </div>

            <!-- Caption -->
            <div>
                <label for="caption" class="block text-sm font-medium text-gray-700 mb-1">Caption (optional)</label>
                <input type="text" id="caption" name="caption" maxlength="255"
                       placeholder="Add a caption for these photos..."
                       class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500">
            </div>

            <!-- Upload Area -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Photos</label>
                <div id="upload-area"
                     class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary-500 transition-colors cursor-pointer"
                     onclick="document.getElementById('file-input').click()">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">
                        <span class="text-primary-600 font-medium">Click to upload</span> or drag and drop
                    </p>
                    <p class="mt-1 text-xs text-gray-500">JPG, PNG, WebP up to 10MB each</p>
                </div>
                <input type="file" id="file-input" class="hidden" multiple accept="image/jpeg,image/png,image/webp">
            </div>

            <!-- Preview Grid -->
            <div id="preview-grid" class="hidden">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-medium text-gray-700">Selected Photos</label>
                    <button type="button" onclick="clearAllFiles()" class="text-sm text-red-600 hover:text-red-700">
                        Clear all
                    </button>
                </div>
                <div id="preview-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
                    <!-- Previews will be inserted here -->
                </div>
            </div>

            <!-- Upload Progress -->
            <div id="upload-progress" class="hidden">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">Uploading...</span>
                    <span id="progress-text" class="text-sm text-gray-500">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-primary-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-end gap-3">
            <a href="/photos"
               class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                Cancel
            </a>
            <button type="button" id="upload-btn" onclick="uploadPhotos()"
                    class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                Upload Photos
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedFiles = [];

function handleShareTypeChange() {
    const shareType = document.querySelector('input[name="share_type"]:checked').value;
    const studentSection = document.getElementById('student-section');
    const studentSelect = document.getElementById('student_id');

    if (shareType === 'STUDENT') {
        studentSection.classList.remove('hidden');
        studentSelect.required = true;
        handleClassChange(); // Load students for selected class
    } else {
        studentSection.classList.add('hidden');
        studentSelect.required = false;
    }
}

async function handleClassChange() {
    const shareType = document.querySelector('input[name="share_type"]:checked').value;
    if (shareType !== 'STUDENT') return;

    const classId = document.getElementById('class_id').value;
    const studentSelect = document.getElementById('student_id');

    if (!classId) {
        studentSelect.innerHTML = '<option value="">Select student...</option>';
        return;
    }

    try {
        const response = await fetch(`/api/v1/students?class_id=${classId}&is_active=true&page_size=100`, {
            credentials: 'same-origin'
        });
        const result = await response.json();

        if (result.data) {
            studentSelect.innerHTML = '<option value="">Select student...</option>';
            result.data.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.first_name} ${student.last_name}`;
                studentSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error fetching students:', error);
    }
}

// File input handling
document.getElementById('file-input').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    addFiles(files);
});

// Drag and drop handling
const uploadArea = document.getElementById('upload-area');

uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.classList.add('border-primary-500', 'bg-primary-50');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.classList.remove('border-primary-500', 'bg-primary-50');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.classList.remove('border-primary-500', 'bg-primary-50');

    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
    addFiles(files);
});

function addFiles(files) {
    files.forEach(file => {
        if (file.size > 10 * 1024 * 1024) {
            ClassUp.toast(`File ${file.name} is too large (max 10MB)`, 'warning');
            return;
        }

        if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
            selectedFiles.push(file);
        }
    });

    updatePreview();
}

function updatePreview() {
    const container = document.getElementById('preview-container');
    const grid = document.getElementById('preview-grid');
    const uploadBtn = document.getElementById('upload-btn');

    if (selectedFiles.length === 0) {
        grid.classList.add('hidden');
        uploadBtn.disabled = true;
        return;
    }

    grid.classList.remove('hidden');
    uploadBtn.disabled = false;
    container.innerHTML = '';

    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'relative aspect-square rounded-lg overflow-hidden group';
            div.innerHTML = `
                <img src="${e.target.result}" class="w-full h-full object-cover">
                <button type="button" onclick="removeFile(${index})"
                        class="absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            container.appendChild(div);
        };
        reader.readAsDataURL(file);
    });
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    updatePreview();
}

function clearAllFiles() {
    selectedFiles = [];
    updatePreview();
    document.getElementById('file-input').value = '';
}

async function uploadPhotos() {
    const shareType = document.querySelector('input[name="share_type"]:checked').value;
    const classId = document.getElementById('class_id').value;
    const studentId = document.getElementById('student_id').value;
    const caption = document.getElementById('caption').value;

    if (!classId && shareType === 'CLASS') {
        ClassUp.toast('Please select a class', 'warning');
        return;
    }

    if (shareType === 'STUDENT' && !studentId) {
        ClassUp.toast('Please select a student', 'warning');
        return;
    }

    if (selectedFiles.length === 0) {
        ClassUp.toast('Please select at least one photo', 'warning');
        return;
    }

    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const uploadBtn = document.getElementById('upload-btn');

    uploadProgress.classList.remove('hidden');
    uploadBtn.disabled = true;

    const uploadedIds = [];
    const total = selectedFiles.length;

    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('file_category', 'PHOTO');

        try {
            const response = await fetch('/api/v1/files/upload', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            });

            const result = await response.json();
            if (response.ok && result.data) {
                uploadedIds.push(result.data.id);
            }
        } catch (error) {
            console.error('Error uploading file:', error);
        }

        const progress = Math.round(((i + 1) / total) * 100);
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${progress}%`;
    }

    if (uploadedIds.length > 0) {
        ClassUp.toast(`${uploadedIds.length} photo(s) uploaded successfully!`, 'success');
        window.location.href = '/photos';
    } else {
        ClassUp.toast('Failed to upload photos. Please try again.', 'error');
    }

    uploadProgress.classList.add('hidden');
    uploadBtn.disabled = false;
}
</script>
{% endblock %}
