{% extends "base.html" %}

{% block title %}{{ report.student.first_name }}'s Report - {{ app_name }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Back Button -->
    <a href="/reports" class="inline-flex items-center text-gray-500 hover:text-gray-700 mb-4">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back
    </a>

    <!-- Report Header -->
    <div class="border-b border-gray-200 pb-4 mb-6">
        <h1 class="text-3xl font-bold text-gray-900">{{ report.student.first_name }}'s Report</h1>
        <p class="text-lg text-gray-600 mt-1">{{ report.report_date.strftime('%A, %b %d, %Y') }}</p>

        <div class="flex items-center gap-3 mt-4">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                {% if report.status == 'FINALIZED' %}bg-green-100 text-green-700
                {% else %}bg-amber-100 text-amber-700{% endif %}">
                {% if report.status == 'DRAFT' %}
                    {% if permissions.is_staff %}
                        Draft ‚Äî Not yet sent to parents
                    {% else %}
                        Draft ‚Äî This report is not yet finalized and may change
                    {% endif %}
                {% else %}
                    Finalized
                {% endif %}
            </span>
            {% if permissions.is_staff and report.status == 'DRAFT' %}
            <a href="/reports/{{ report.id }}/edit"
               class="text-sm text-primary-600 hover:text-primary-700 font-medium">
                Edit Report
            </a>
            <button type="button" onclick="finalizeReport()"
                    class="text-sm text-green-600 hover:text-green-700 font-medium">
                Finalize & Send
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Report Sections -->
    <div class="space-y-8">
        {% for section in report.template.sections %}
        {% set section_data = report.report_data.sections.get(section.id, {}) if report.report_data and report.report_data.sections else {} %}
        {% set section_color = section.get('color', 'purple') %}

        <div class="report-section">
            <!-- Section Title with Color -->
            <h2 class="text-2xl font-bold mb-3
                {% if section_color == 'purple' or section_color == 'violet' %}text-violet-600
                {% elif section_color == 'green' %}text-green-600
                {% elif section_color == 'orange' %}text-orange-500
                {% elif section_color == 'blue' %}text-blue-600
                {% elif section_color == 'red' %}text-red-600
                {% else %}text-violet-600{% endif %}">
                {{ section.title }}
            </h2>

            {% if section.type == 'REPEATABLE_ENTRIES' %}
                {% set entries = section_data.get('entries', []) %}
                {% if entries %}
                <div class="space-y-2">
                    {% for entry in entries %}
                    <p class="text-gray-800">
                        {% if section.id == 'naps' %}
                            <!-- Nap entry format: start - end (duration) -->
                            üõèÔ∏è {{ entry.get('start_time', '') }} - {{ entry.get('end_time', '') }}
                            {% if entry.get('duration') %}
                            <span class="font-semibold text-violet-600">({{ entry.get('duration') }})</span>
                            {% endif %}
                        {% elif section.id == 'fluids' %}
                            <!-- Fluid entry format: time - amount - type -->
                            {{ entry.get('time', '') }} - {{ entry.get('amount', 'none') | lower }} - {{ entry.get('type', '') }}
                            {% if entry.get('notes') %}
                            <br><em class="text-gray-500">{{ entry.get('notes') }}</em>
                            {% endif %}
                        {% elif section.id == 'bathroom' %}
                            <!-- Bathroom entry format: time - type - condition, notes -->
                            {{ entry.get('time', '') }} - {{ entry.get('type', 'Diaper') }} - {{ entry.get('condition', '') }}{% if entry.get('notes') %}, {{ entry.get('notes') }}{% endif %}
                        {% else %}
                            <!-- Generic entry format -->
                            {% for field in section.fields %}
                                {% if not loop.first %} - {% endif %}
                                {{ entry.get(field.id, '') }}
                            {% endfor %}
                        {% endif %}
                    </p>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-400 italic">No entries recorded</p>
                {% endif %}

            {% elif section.type == 'MEALS' or section.id == 'meals' %}
                <!-- Special handling for meals section -->
                <div class="space-y-2">
                    {% for field in section.fields %}
                        {% set amount = section_data.get(field.id ~ '_amount', '') %}
                        {% set desc = section_data.get(field.id ~ '_desc', section_data.get(field.id, '')) %}
                        {% if amount or desc %}
                        <p class="text-gray-800">
                            <span class="font-semibold">{{ field.label }}</span>
                            {% if amount %} - {{ amount }}{% endif %}
                            {% if desc %} - {{ desc }}{% endif %}
                        </p>
                        {% endif %}
                    {% endfor %}
                </div>

            {% elif section.type == 'CHECKLIST' %}
                <div class="space-y-2">
                    {% set has_any = false %}
                    {% for field in section.fields %}
                    {% set field_value = section_data.get(field.id, '') %}
                    {% set field_desc = section_data.get(field.id ~ '_desc', section_data.get(field.id ~ '_notes', '')) %}
                    {% if field.type == 'CHECKBOX' %}
                        {% if field_value == true or field_value == 'true' %}
                        {% set has_any = true %}
                        <p class="text-gray-800 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            {{ field.label }}
                        </p>
                        {% endif %}
                    {% elif field_value or field_desc %}
                    {% set has_any = true %}
                    <p class="text-gray-800">
                        <span class="font-semibold">{{ field.label }}</span>
                        {% if field_value %} - {{ field_value }}{% endif %}
                        {% if field_desc %} - {{ field_desc }}{% endif %}
                    </p>
                    {% endif %}
                    {% endfor %}
                    {% if not has_any %}
                    <p class="text-gray-400 italic">No activities recorded</p>
                    {% endif %}
                </div>

            {% elif section.type == 'NARRATIVE' %}
                {% for field in section.fields %}
                {% set field_value = section_data.get(field.id, '') %}
                {% if field_value %}
                <p class="text-gray-800 whitespace-pre-wrap">{{ field_value }}</p>
                {% else %}
                <p class="text-gray-400 italic">No notes recorded</p>
                {% endif %}
                {% endfor %}

            {% else %}
                <!-- Default rendering for other section types -->
                <div class="space-y-2">
                    {% for field in section.fields %}
                    {% set field_value = section_data.get(field.id, '') %}
                    {% if field_value %}
                    <p class="text-gray-800">
                        <span class="font-semibold">{{ field.label }}:</span> {{ field_value }}
                    </p>
                    {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Teacher Notes (if exists as separate section) -->
    {% if report.report_data and report.report_data.sections and report.report_data.sections.get('notes') %}
    <div class="mt-8 pt-6 border-t border-gray-200">
        <h2 class="text-2xl font-bold text-gray-700 mb-3">Teacher's Notes</h2>
        <p class="text-gray-800 whitespace-pre-wrap">{{ report.report_data.sections.notes.get('content', '') }}</p>
    </div>
    {% endif %}

    <!-- Footer Actions -->
    <div class="mt-8 pt-6 border-t border-gray-200 flex justify-between items-center">
        <p class="text-sm text-gray-500">
            {% if report.finalized_at %}
            Sent on {{ report.finalized_at.strftime('%b %d, %Y at %H:%M') }}
            {% else %}
            Created by {{ report.created_by_user.first_name }} {{ report.created_by_user.last_name }}
            {% endif %}
        </p>
        <button type="button" onclick="window.print()"
                class="inline-flex items-center px-4 py-2 text-gray-600 hover:text-gray-800">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
            </svg>
            Print
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function finalizeReport() {
    if (!(await ClassUp.confirm('Are you sure you want to finalize this report? This will notify parents and the report cannot be edited afterwards.', { confirmText: 'Finalize' }))) {
        return;
    }

    try {
        const response = await fetch('/api/v1/reports/{{ report.id }}/finalize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ notify_parents: true })
        });

        const result = await response.json();

        if (response.ok) {
            ClassUp.toast('Report finalized and sent to parents!', 'success');
            window.location.reload();
        } else {
            ClassUp.toast(result.message || 'Failed to finalize report', 'error');
        }
    } catch (error) {
        console.error('Error finalizing report:', error);
        ClassUp.toast('An error occurred while finalizing the report', 'error');
    }
}
</script>

<style>
@media print {
    nav, .no-print, button, a[href="/reports"] {
        display: none !important;
    }
    .report-section {
        page-break-inside: avoid;
    }
}
</style>
{% endblock %}
