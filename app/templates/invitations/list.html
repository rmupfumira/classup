{% extends "base.html" %}

{% block title %}Parent Invitations - {{ app_name }}{% endblock %}

{% block content %}
<div class="space-y-5">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-xl font-semibold text-neutral-800">Parent Invitations</h1>
            <p class="mt-0.5 text-sm text-neutral-500">
                {{ total }} invitation{{ 's' if total != 1 else '' }} total
            </p>
        </div>
        <button type="button" onclick="document.getElementById('invite-parent-dialog').showModal()"
                class="inline-flex items-center px-3 py-1.5 bg-primary-500 text-white text-sm rounded hover:bg-primary-600 transition-colors">
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"></path>
            </svg>
            Invite Parent
        </button>
    </div>

    <!-- Status Filter Bar -->
    <div class="bg-white rounded-lg shadow-card border border-neutral-200 p-3">
        <div class="flex flex-wrap gap-2">
            <a href="/invitations"
               class="px-3 py-1.5 text-sm rounded-md transition-colors
                      {% if not current_status %}bg-primary-50 text-primary-700 font-medium{% else %}text-neutral-600 hover:bg-neutral-100{% endif %}">
                All
            </a>
            <a href="/invitations?status=pending"
               class="px-3 py-1.5 text-sm rounded-md transition-colors
                      {% if current_status == 'pending' %}bg-amber-50 text-amber-700 font-medium{% else %}text-neutral-600 hover:bg-neutral-100{% endif %}">
                Pending
            </a>
            <a href="/invitations?status=accepted"
               class="px-3 py-1.5 text-sm rounded-md transition-colors
                      {% if current_status == 'accepted' %}bg-green-50 text-green-700 font-medium{% else %}text-neutral-600 hover:bg-neutral-100{% endif %}">
                Accepted
            </a>
            <a href="/invitations?status=expired"
               class="px-3 py-1.5 text-sm rounded-md transition-colors
                      {% if current_status == 'expired' %}bg-neutral-200 text-neutral-700 font-medium{% else %}text-neutral-600 hover:bg-neutral-100{% endif %}">
                Expired
            </a>
        </div>
    </div>

    <!-- Invitations List -->
    {% if invitations %}
    <div class="bg-white rounded-lg shadow-card border border-neutral-200 overflow-hidden">
        <!-- Desktop Table -->
        <div class="hidden md:block overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="bg-neutral-50 border-b border-neutral-200">
                        <th class="px-4 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">
                            Email
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">
                            Student
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">
                            Created By
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">
                            Expires
                        </th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-neutral-500 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-neutral-100">
                    {% for inv in invitations %}
                    <tr class="hover:bg-neutral-50 transition-colors" id="row-{{ inv.id }}">
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-9 w-9 rounded-full bg-primary-50 flex items-center justify-center">
                                    <svg class="h-4 w-4 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                              d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-neutral-800">{{ inv.email }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-neutral-600">
                            <a href="/students/{{ inv.student_id }}" class="text-primary-600 hover:underline">
                                {{ inv.student_name }}
                            </a>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            {% if inv.status == 'PENDING' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-50 text-amber-700">
                                Pending
                            </span>
                            {% elif inv.status == 'ACCEPTED' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-50 text-green-700">
                                Accepted
                            </span>
                            {% elif inv.status == 'EXPIRED' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-neutral-100 text-neutral-600">
                                Expired
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-neutral-100 text-neutral-600">
                                {{ inv.status }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-neutral-600">
                            {{ inv.created_by_name }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-neutral-500">
                            {% if inv.status == 'ACCEPTED' and inv.accepted_at %}
                                Accepted {{ inv.accepted_at.strftime('%b %d, %Y') }}
                            {% elif inv.expires_at %}
                                {{ inv.expires_at.strftime('%b %d, %Y') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right">
                            {% if inv.status == 'PENDING' %}
                            <div class="flex items-center justify-end gap-2">
                                <button type="button" onclick="resendInvitation('{{ inv.id }}')"
                                        class="text-xs text-primary-600 hover:text-primary-700 font-medium">
                                    Resend
                                </button>
                                <button type="button" onclick="cancelInvitation('{{ inv.id }}')"
                                        class="text-xs text-red-600 hover:text-red-700 font-medium">
                                    Cancel
                                </button>
                            </div>
                            {% elif inv.status == 'EXPIRED' %}
                            <span class="text-xs text-neutral-400">Expired</span>
                            {% else %}
                            <span class="text-xs text-neutral-400">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile Cards -->
        <div class="md:hidden divide-y divide-neutral-100">
            {% for inv in invitations %}
            <div class="p-4" id="card-{{ inv.id }}">
                <div class="flex items-start justify-between">
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full bg-primary-50 flex items-center justify-center">
                            <svg class="h-4 w-4 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                      d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-neutral-800">{{ inv.email }}</p>
                            <p class="text-xs text-neutral-500">
                                For <a href="/students/{{ inv.student_id }}" class="text-primary-600 hover:underline">{{ inv.student_name }}</a>
                            </p>
                        </div>
                    </div>
                    {% if inv.status == 'PENDING' %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-50 text-amber-700">
                        Pending
                    </span>
                    {% elif inv.status == 'ACCEPTED' %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-50 text-green-700">
                        Accepted
                    </span>
                    {% elif inv.status == 'EXPIRED' %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-neutral-100 text-neutral-600">
                        Expired
                    </span>
                    {% endif %}
                </div>
                <div class="mt-2 ml-13 text-xs text-neutral-500">
                    Created by {{ inv.created_by_name }}
                    {% if inv.expires_at %} &middot; Expires {{ inv.expires_at.strftime('%b %d, %Y') }}{% endif %}
                </div>
                {% if inv.status == 'PENDING' %}
                <div class="mt-2 ml-13 flex gap-3">
                    <button type="button" onclick="resendInvitation('{{ inv.id }}')"
                            class="text-xs text-primary-600 hover:text-primary-700 font-medium">
                        Resend
                    </button>
                    <button type="button" onclick="cancelInvitation('{{ inv.id }}')"
                            class="text-xs text-red-600 hover:text-red-700 font-medium">
                        Cancel
                    </button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="flex items-center justify-between bg-white px-4 py-3 rounded-lg shadow-card border border-neutral-200">
        <div class="hidden sm:flex sm:items-center sm:justify-between w-full">
            <p class="text-sm text-neutral-600">
                Page <span class="font-medium">{{ page }}</span> of <span class="font-medium">{{ total_pages }}</span>
            </p>
            <div class="flex gap-2">
                {% if page > 1 %}
                <a href="?page={{ page - 1 }}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_student_id %}&student_id={{ current_student_id }}{% endif %}"
                   class="px-3 py-1.5 text-sm text-neutral-700 bg-white border border-neutral-300 rounded hover:bg-neutral-50">
                    Previous
                </a>
                {% endif %}
                {% if page < total_pages %}
                <a href="?page={{ page + 1 }}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_student_id %}&student_id={{ current_student_id }}{% endif %}"
                   class="px-3 py-1.5 text-sm text-neutral-700 bg-white border border-neutral-300 rounded hover:bg-neutral-50">
                    Next
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Empty State -->
    <div class="bg-white rounded-lg shadow-card border border-neutral-200 p-10 text-center">
        <div class="w-14 h-14 bg-neutral-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="h-7 w-7 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"></path>
            </svg>
        </div>
        <h3 class="text-base font-semibold text-neutral-800">
            {% if current_status %}
                No {{ current_status }} invitations
            {% else %}
                No invitations yet
            {% endif %}
        </h3>
        <p class="mt-1 text-sm text-neutral-500">
            {% if current_status %}
                Try a different filter or invite a new parent.
            {% else %}
                Invite parents by email so they can create an account and stay connected.
            {% endif %}
        </p>
        <div class="mt-5">
            <button type="button" onclick="document.getElementById('invite-parent-dialog').showModal()"
                    class="inline-flex items-center px-3 py-1.5 bg-primary-500 text-white text-sm rounded hover:bg-primary-600 transition-colors">
                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"></path>
                </svg>
                Invite Parent
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Invite Parent Dialog -->
<dialog id="invite-parent-dialog" class="rounded-xl shadow-xl p-0 w-full max-w-md backdrop:bg-black/50">
    <div class="p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-neutral-800">Invite Parent</h2>
            <button type="button" onclick="document.getElementById('invite-parent-dialog').close()"
                    class="text-neutral-400 hover:text-neutral-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <form id="invite-parent-form" class="space-y-4">
            <div>
                <label for="inv-student" class="block text-sm font-medium text-neutral-700 mb-1">Student</label>
                <select id="inv-student" name="student_id" required
                        class="block w-full h-9 px-3 text-sm border border-neutral-300 rounded-md bg-white
                               focus:border-primary-500 focus:ring-0">
                    <option value="">Select a student...</option>
                    {% for s in students %}
                    <option value="{{ s.id }}">{{ s.first_name }} {{ s.last_name }}{% if s.school_class %} ({{ s.school_class.name }}){% endif %}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label for="inv-first-name" class="block text-sm font-medium text-neutral-700 mb-1">First Name</label>
                    <input type="text" id="inv-first-name" name="first_name" required
                           class="block w-full h-9 px-3 text-sm border border-neutral-300 rounded-md bg-white
                                  focus:border-primary-500 focus:ring-0"
                           placeholder="Parent's first name">
                </div>
                <div>
                    <label for="inv-last-name" class="block text-sm font-medium text-neutral-700 mb-1">Last Name</label>
                    <input type="text" id="inv-last-name" name="last_name" required
                           class="block w-full h-9 px-3 text-sm border border-neutral-300 rounded-md bg-white
                                  focus:border-primary-500 focus:ring-0"
                           placeholder="Parent's last name">
                </div>
            </div>
            <div>
                <label for="inv-email" class="block text-sm font-medium text-neutral-700 mb-1">Parent Email</label>
                <input type="email" id="inv-email" name="email" required
                       class="block w-full h-9 px-3 text-sm border border-neutral-300 rounded-md bg-white
                              focus:border-primary-500 focus:ring-0"
                       placeholder="parent@example.com">
            </div>
            <p class="text-xs text-neutral-500">
                The parent's name and email will be pre-filled on their registration form. They only need to set a password.
            </p>
            <div id="inv-error" class="hidden text-sm text-red-600 bg-red-50 border border-red-200 rounded-md p-3"></div>
            <div id="inv-success" class="hidden text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-3"></div>
            <div class="flex justify-end gap-3 pt-2">
                <button type="button" onclick="document.getElementById('invite-parent-dialog').close()"
                        class="px-4 py-2 text-sm text-neutral-700 bg-white border border-neutral-300 rounded-md hover:bg-neutral-50">
                    Cancel
                </button>
                <button type="submit" id="inv-submit-btn"
                        class="px-4 py-2 text-sm text-white bg-primary-500 rounded-md hover:bg-primary-600">
                    Send Invitation
                </button>
            </div>
        </form>
    </div>
</dialog>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('invite-parent-form');
    const errorDiv = document.getElementById('inv-error');
    const successDiv = document.getElementById('inv-success');
    const submitBtn = document.getElementById('inv-submit-btn');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        errorDiv.classList.add('hidden');
        successDiv.classList.add('hidden');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';

        const data = {
            student_id: form.student_id.value,
            email: form.email.value,
            first_name: form.first_name.value,
            last_name: form.last_name.value,
        };

        try {
            const response = await fetch('/api/v1/invitations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify(data),
            });

            const result = await response.json();

            if (result.status === 'success') {
                successDiv.textContent = result.message || 'Invitation sent successfully!';
                successDiv.classList.remove('hidden');
                form.reset();
                setTimeout(() => window.location.reload(), 1500);
            } else {
                errorDiv.textContent = result.detail || result.message || 'Failed to send invitation';
                errorDiv.classList.remove('hidden');
            }
        } catch (error) {
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.classList.remove('hidden');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send Invitation';
        }
    });
});

async function resendInvitation(invitationId) {
    if (!(await ClassUp.confirm('Resend invitation email with a new code?', { title: 'Confirm', confirmText: 'Resend' }))) return;

    try {
        const response = await fetch(`/api/v1/invitations/${invitationId}/resend`, {
            method: 'POST',
            credentials: 'same-origin',
        });
        const result = await response.json();
        if (result.status === 'success') {
            ClassUp.toast('Invitation resent successfully', 'success');
        } else {
            ClassUp.toast(result.detail || result.message || 'Failed to resend invitation', 'error');
        }
    } catch (error) {
        ClassUp.toast('An error occurred. Please try again.', 'error');
    }
}

async function cancelInvitation(invitationId) {
    if (!(await ClassUp.confirm('Cancel this invitation? The parent will no longer be able to use it to register.', { danger: true, confirmText: 'Cancel Invitation' }))) return;

    try {
        const response = await fetch(`/api/v1/invitations/${invitationId}`, {
            method: 'DELETE',
            credentials: 'same-origin',
        });
        const result = await response.json();
        if (result.status === 'success') {
            window.location.reload();
        } else {
            ClassUp.toast(result.detail || result.message || 'Failed to cancel invitation', 'error');
        }
    } catch (error) {
        ClassUp.toast('An error occurred. Please try again.', 'error');
    }
}
</script>
{% endblock %}
